import {decorate, observable, observe} from "mobx"import dbLoader from "../../utils/dbLoader"import {kingdoms} from "./kingdoms"import {BuildingList} from "./buildings/buildings"import {ImprovementList} from "./hexImprovements/ImprovmentsMilo"import {TerrainList} from "./hexImprovements/TerrainMilo"import {computedFn} from "mobx-utils"import Settings from "../../settings/Settings"class Accumulator {	economy = 0	stability = 0	loyalty = 0	defense = 0	unrest = 0	fame = 0	consumption = 0	bp = 0}function buildingReducer(acc, {building}) {	acc.economy += building.bonus.economy	acc.stability += building.bonus.stability	acc.loyalty += building.bonus.loyalty	acc.defense += building.bonus.defense	acc.unrest += building.bonus.unrest	acc.fame += building.bonus.fame	return acc}function improvementReducer(acc, {improvement}) {	acc.economy += improvement.bonus.economy	acc.stability += improvement.bonus.stability	acc.loyalty += improvement.bonus.loyalty	acc.unrest += improvement.bonus.unrest	acc.consumption += improvement.bonus.consumption	acc.bp += improvement.bonus.bp	return acc}class BuildingDetails {	id = 0	building = null	x = 0	y = 0	rotation = 0	buildingGrid = null	constructor(obj, grid) {		this.id = obj.id		this.building = BuildingList.getById(obj.building)		this.x = obj.x		this.y = obj.y		this.rotation = obj.rotation		this.buildingGrid = grid	}	toFormData = () => {		const formData = new FormData()		formData.append("building", this.building.id.toString())		formData.append("xcoord", this.x.toString())		formData.append("ycoord", this.y.toString())		formData.append("rotation", this.rotation.toString())		formData.append("district", this.buildingGrid.district.id.toString())		return formData	}}class BuildingGrid {	buildings = []	district = null	constructor(obj, district) {		if (obj != null)			obj.forEach((b) => {				this.buildings.push(new BuildingDetails(b, this))			})		this.district = district	}	addBuilding = (x, y, building, rotation) => {		if (!building || x < 0 || y < 0) return		const kingdomData = this.district.settlement.hex.ownedBy.kingdomData		const discount = this.district.settlement.applyDiscountFor(building)		const price = (discount ? Math.ceil(building.bpCost / 2) : building.bpCost)		if (kingdomData.data.treasury < price) return		const newBuilding = new BuildingDetails({id: -1, building: building.id, x: x, y: y, rotation: rotation}, this)		dbLoader("district/buildings", "PUT", newBuilding.toFormData())			.then((b) => newBuilding.id = b.id)		this.buildings.push(newBuilding)		building.discounts.forEach(value => {			this.district.settlement.addDiscountFor(BuildingList.getByType(value))		})		kingdomData.data.treasury -= price		kingdomData.saveToDb()	}	upgradeBuilding = (x, y, building) => {		//TODO !!! upgrades	}	removeBuilding = (x, y) => {		const index = this.buildings.findIndex(b => b.x === x && b.y === y)		console.log(index)		if (index < 0) return		dbLoader(`district/buildings/${this.district.id}/${x}-${y}`, "DELETE")		this.buildings.splice(index, 1)	}	getBuildingGridModifiers(accumulator) {		if (this.buildings.length > 0)			return this.buildings.reduce(buildingReducer, accumulator)		return accumulator	}	getBuilding = (x, y) => {		if (x < 0 || x > 5 || y < 0 || y > 5) return null		return this.buildings.find(({x: bx, y: by, rotation: br, building: b}) =>			(x === bx && y === by)			|| (x === bx + 1 && y === by && (b.size === 4 || (b.size === 2 && br % 2 === 0)))			|| (x === bx && y === by + 1 && (b.size === 4 || (b.size === 2 && br % 2 === 1)))			|| (x === bx + 1 && y === by + 1 && b.size === 4))	}	updateBuildings = (id, obj) => {		const index = this.buildings.findIndex(v => v.id === id || v.id === -1)		if (!obj && index >= 0) {			this.buildings.splice(index, 1)		} else if (obj && index < 0 && obj.district === this.district.id) {			this.buildings.push(new BuildingDetails(obj, this))		}	}}decorate(BuildingGrid, {	buildings: observable.shallow,})class District {	id = 0	settlement = null	buildingGrid = null	constructor(obj, settlement) {		this.settlement = settlement		if (obj == null) {			this.buildingGrid = new BuildingGrid(null, this)		} else {			this.id = obj.id			this.buildingGrid = new BuildingGrid(obj.buildings, this)		}	}	saveDistrict = () => {		// TODO terribly broken		return dbLoader(`district/${this.id}`, "POST", this.toFormData())	}	toFormData = () => {		const formData = new FormData()		formData.append("settlement", this.settlement.id.toString())		return formData	}	getDistrictModifiers(accumulator) {		if (this.buildingGrid != null)			return this.buildingGrid.getBuildingGridModifiers(accumulator)		return accumulator	}	update = (obj) => {		console.warn("District.update not implemented, apparently necessary?")	}	updateBuildings = (id, obj) => {		if (this.buildingGrid)			this.buildingGrid.updateBuildings(id, obj)	}}class Settlement {	id = 0	hex = 0	districts = []	settlementImprovements = []	discounts = []	name = "Unnamed settlement"	deleted = false	constructor(obj, hex) {		this.hex = hex		if (obj != null) {			this.id = obj.id			this.name = obj.name			if (obj.districts != null)				obj.districts.forEach((d) => {					this.districts.push(new District(d, this))				})			if (obj.settlementImprovements != null && obj.settlementImprovements.length > 0) {				obj.settlementImprovements.forEach((v) => {					this.settlementImprovements.push({id: v.id, building: BuildingList.getById(v.building)})				})			}			if (obj.discounts != null && obj.discounts.length > 0) {				obj.discounts.forEach(d => {					this.discounts.push({id: d.id, building: BuildingList.getById(d.building)})				})			}		}	}	loadFromDb = () => {		dbLoader(`settlement/${this.id}`, "GET")			.then(data => {				this.name = data.name			})	}	saveSettlement = () => {		return dbLoader(`settlement/${this.id}`, "POST", this.toFormData())	}	addDiscountFor = (building) => {		const discount = {id: 0, building: building}		const formData = new FormData()		formData.append("building", building.id.toString())		formData.append("settlement", this.id.toString())		dbLoader(`settlement/discounts`, "PUT", formData)			.then((reply) => {				discount.id = reply.id			})		this.discounts.push(discount)	}	applyDiscountFor = (building) => {		const index = this.discounts.findIndex(d => d.building.id === building.id)		if (index < 0)			return false		dbLoader(`settlement/discounts/${this.discounts[index].id}`, "DELETE", null)			.then((s) => {				this.discounts.splice(index, 1)			})		return true	}	addDistrict = () => {		const newDistrict = new District(null, this)		this.districts.push(newDistrict)		dbLoader("district", "PUT", newDistrict.toFormData())			.then((out) => {				newDistrict.id = out.id			})	}	toFormData = () => {		const formData = new FormData()		formData.append("name", this.name.replace("'", "''"))		formData.append("hex", this.hex.id.toString())		return formData	}	deleteDistrict = async (id) => {		const index = this.getDistrictIndexById(id)		if (index < 0) return		this.districts.splice(index, 1)		await dbLoader(`district/${id}`, "DELETE", null)		this.deleted = true	}	addImprovement = (building) => {		if (!building) return false		const discount = this.applyDiscountFor(building)		const kingdomData = this.hex.ownedBy.kingdomData		const price = (discount ? Math.ceil(building.bpCost / 2) : building.bpCost)		if (this.hex.ownedBy.kingdomData.data.treasury < price)			return false		const newImprovement = {id: -1, building: building}		const formData = new FormData()		formData.append("building", building.id.toString())		formData.append("settlement", this.id.toString())		dbLoader(`settlement/improvements`, "PUT", formData)			.then(obj => newImprovement.id = obj.id)		this.settlementImprovements.push(newImprovement)		kingdomData.data.treasury -= price		kingdomData.saveToDb()	}	removeImprovement = (building) => {		const index = this.settlementImprovements.findIndex(b => b.building.id === building.id)		if (index >= 0) {			dbLoader(				`settlement/improvements/${this.settlementImprovements[index].id}`,				"DELETE",				null)			this.settlementImprovements.splice(index, 1)		}	}	getDistrictIndexById = (id) => {		return this.districts.findIndex((value) => value.id === id)	}	getDistrictByID = (id) => {		const index = this.getDistrictByID(id)		if (index > 0)			return this.districts[index]		return null	}	hasImprovement = computedFn((building) => {		return this.settlementImprovements.some(v => v.building.id === building.id)	})	getSettlementModifiers(acc) {		if (this.districts.length > 0)			this.districts.reduce((acc, d) => {				return d.getDistrictModifiers(acc)			}, acc)		if (this.settlementImprovements.length > 0)			this.settlementImprovements.reduce(buildingReducer, acc)		return acc	}	update = (obj) => {		this.name = obj.name	}	updateDiscounts = (id, obj) => {		const index = this.discounts.findIndex(v => v.id === id)		if (!obj && index >= 0) {			this.discounts.splice(index, 1)		} else if (obj && index < 0 && obj.settlement === this.id) {			this.discounts.push({id: obj.id, building: BuildingList.getById(obj.building)})		}	}	updateDistricts = (id, obj) => {		const index = this.districts.findIndex(v => v.id === id)		if (!obj && index >= 0) {			this.districts.splice(index, 1)		} else if (obj && index < 0 && obj.settlement === this.id) {			this.districts.push(new District(obj, this))		} else if (obj && index >= 0) {			this.districts.update(obj)		}	}	updateBuildings = (id, obj) => {		this.districts.forEach(v => v.updateBuildings(id, obj))	}	updateSettlementImprovements = (id, obj) => {		const index = this.settlementImprovements.findIndex(v => v.id === id || v.id === -1)		if (!obj && index >= 0) {			this.settlementImprovements.splice(index, 1)		} else if (obj && index < 0 && this.id === obj.settlement) {			this.settlementImprovements.push({id: id, building: BuildingList.getById(obj.building)})		}	}}decorate(Settlement, {	districts: observable.shallow,	settlementImprovements: observable.shallow,})class HexData {	id = 0	x = 0	y = 0	ownedBy = null	label = ""	terrainType = null	settlement = null	hexImprovements = []	constructor(obj) {		this.id = obj.id		this.x = obj.x		this.y = obj.y		this.terrainType = TerrainList.getById(obj.terrainType)		this.settlement = ((obj.settlement && Object.keys(obj.settlement).length > 0) ? (new Settlement(obj.settlement, this)) : null)		this.label = obj.label ? obj.label.replace(/↓/g, "\n") : ""		if (obj.hexImprovements) {			obj.hexImprovements.forEach(v =>				this.hexImprovements.push({id: v.id, improvement: ImprovementList.getById(v.improvement)},				))		}		const setOwnedBy = observe(kingdoms, "finishedLoading", change => {			if (change.newValue) {				this.ownedBy = kingdoms.getById(obj.ownedBy)				setOwnedBy()			}		})	}	saveToDb = () => {		dbLoader(`hex/${this.x}-${this.y}`, "POST", this.toFormData())			.then((response) => {				this.id = response.id			})	}	hasImprovement = (improvement) => {		const index = this.hexImprovements.findIndex(value => value.improvement.id === improvement.id)		return index >= 0;	}	addImprovement = (improvement, cost) => {		if (!this.ownedBy) return false		if (!improvement) return false		if (this.ownedBy.kingdomData.data.treasury < cost)			return false		this.ownedBy.kingdomData.data.treasury -= cost		this.ownedBy.kingdomData.saveToDb()		const newImprovement = {id: -1, improvement: improvement}		const index = this.hexImprovements.push(newImprovement) - 1		const formData = new FormData()		formData.append("improvement", improvement.id.toString())		formData.append("hex", this.id.toString())		dbLoader("hexImprovements", "PUT", formData)			.then(reply => {				this.hexImprovements[index].id = reply.id				console.log("adding", this.hexImprovements[index])			})		return true	}	removeImprovement = (improvement) => {		if (!improvement) return		const index = this.hexImprovements.findIndex(value => value.improvement.id === improvement.id)		console.log("removing", this.hexImprovements[index])		dbLoader(`hexImprovements/${this.hexImprovements[index].id}`, "DELETE")			.then(reply => {				this.hexImprovements.splice(index, 1)			})	}	setTerrain = (terrain) => {		this.terrainType = terrain		this.saveToDb()	}	createSettlement = () => {		if (this.settlement == null) {			this.settlement = new Settlement(null, this)			dbLoader("settlement", "PUT", this.settlement.toFormData())				.then((out) => this.settlement.id = out.id)		}	}	update = obj => {		this.ownedBy = kingdoms.getById(obj.ownedBy)		this.terrainType = TerrainList.getById(obj.terrainType)	}	updateSettlement = (id, obj) => {		if (obj && this.settlement && this.settlement.id === id) {			this.settlement.update(obj)		} else if (!obj && this.settlement && this.settlement.id === id) {			this.settlement = null		} else if (obj && !this.settlement && obj.hex === this.id) {			this.settlement = new Settlement(obj, this)		}	}	updateImprovements = (id, obj) => {		const index = this.hexImprovements.findIndex(v => (v.id === id || v.id === -1))		console.log("index, id", index, id)		if (index >= 0) {			console.log(obj)		}		if (obj && index < 0 && obj.hex === this.id) {			this.hexImprovements.push({id: id, improvement: ImprovementList.getById(obj.improvement)})			console.log("ADD", this.hexImprovements)		} else if (!obj && index >= 0) {			this.hexImprovements.splice(index, 1)			console.log("REMOVE", this.hexImprovements)		}	}	updateDiscounts = (id, obj) => {		if (this.settlement)			this.settlement.updateDiscounts(id, obj)	}	updateDistricts = (id, obj) => {		if (this.settlement)			this.settlement.updateDistricts(id, obj)	}	updateBuildings = (id, obj) => {		if (this.settlement)			this.settlement.updateBuildings(id, obj)	}	updateSettlementImprovements = (id, obj) => {		if (this.settlement)			this.settlement.updateSettlementImprovements(id, obj)	}	toFormData = () => {		const formData = new FormData()		formData.append("xcoord", this.x.toString())		formData.append("ycoord", this.y.toString())		formData.append("owned_by", (this.ownedBy != null && this.ownedBy.id != null) ? this.ownedBy.id.toString() : 0)		formData.append("terrain_type", this.terrainType ? this.terrainType.id.toString() : "0")		formData.append("label", this.label.replace(/'/g, "''").replace(/\n/g, "↓"))		return formData	}	loadFromDb = () => {		dbLoader(`hex/${this.id}`, "GET")			.then((data) => {				this.ownedBy = kingdoms.getById(data.ownedBy)				this.terrainType = TerrainList.getById(data.terrainType)			})	}	getSettlementModifiers = (acc) => {		if (this.settlement != null)			acc = this.settlement.getSettlementModifiers(acc)		if (this.hexImprovements.length > 0) {			this.hexImprovements.reduce(improvementReducer, acc)		}		return acc	}}class HexDataGrid {	hexGrid = observable([])	loaded = false	selected = -1	initialize = () => {		this.loaded = false		dbLoader("hex/hexData", "GET")			.then((hexes) => {				hexes.forEach((hex) => {					this.hexGrid.push(new HexData(hex))				})				this.loaded = true				Settings.socket.on("hex", (id) => {					const hex = this.getById(id)					if (hex)						hex.loadFromDb()					else						dbLoader("hex/" + id, "GET")							.then(newHex => {								const hexIndex = this.hexGrid.findIndex(v => v.id === id)								if (hexIndex < 0) {									this.hexGrid.push(new HexData(newHex))								} else {									this.hexGrid[hexIndex].update(newHex)								}							})				})				Settings.socket.on("settlement", id => {					dbLoader("settlement", "GET")						.then(newSettlement => {							this.hexGrid.forEach(v => v.updateSettlement(id, newSettlement))						})				})				Settings.socket.on("settlementImprovements", id => {					dbLoader("settlement/improvements/" + id, "GET")						.then(newImprovement => {							this.hexGrid.forEach(v => v.updateSettlementImprovements(id, newImprovement))						})				})				Settings.socket.on("buildingDiscount", id => {					dbLoader("settlement/discounts/" + id, "GET")						.then(newDiscount => {							this.hexGrid.forEach(v => v.updateDiscounts(id, newDiscount))						})				})				Settings.socket.on("hexImprovements", id => {					dbLoader("hexImprovements/" + id, "GET")						.then(newImprovement => {							this.hexGrid.forEach(v => v.updateImprovements(id, newImprovement))						})				})				Settings.socket.on("district", id => {					dbLoader("district/" + id, "GET")						.then(newDistrict => {							this.hexGrid.forEach(v => v.updateDistricts(id, newDistrict))						})				})				Settings.socket.on("districtBuildings", id => {					dbLoader("district/buildings/" + id)						.then(newBuilding => {							this.hexGrid.forEach(v => v.updateBuildings(id, newBuilding))						})				})			})	}	getById = (id) => {		this.hexGrid.forEach((hex) => {			if (hex.id === id)				return hex		})		return null	}	getByCoords = (x, y) => {		for (let i = 0; i < this.hexGrid.length; i++)			if (this.hexGrid[i].x === x && this.hexGrid[i].y === y) {				return this.hexGrid[i]			}		const newHexData = new HexData({id: 0, x: x, y: y, ownedBy: -1, terrainType: -1})		this.hexGrid.push(newHexData)		return newHexData	}	getByKingdom = computedFn((id) => {		// const out = []		return this.hexGrid.filter(value => value.ownedBy && value.ownedBy.id === id)		// for (let i = 0; i < this.hexGrid.length; i++)		// 	if (this.hexGrid[i].ownedBy != null && this.hexGrid[i].ownedBy.id === id)		// 		out.push(this.hexGrid[i])		// return out	}, true)	getModifiersByKingdomId = (id) => {		if (id <= 0) return new Accumulator()		const acc = new Accumulator()		this.getByKingdom(id).forEach((value => {			value.getSettlementModifiers(acc)		}))		return acc	}	getBuildingCountByKingdomId = computedFn((id) => {		if (id <= 0) return {}		const acc = {}		return this.getByKingdom(id).reduce((hexAcc, hex) => {			let acc = hexAcc			acc = hex.hexImprovements.reduce((imprAcc, improvement) => {				if (imprAcc[improvement.improvement.name]) {					imprAcc[improvement.improvement.name].count++				} else {					imprAcc[improvement.improvement.name] = {building: improvement.improvement, count: 1}				}				return imprAcc			}, hexAcc)			if (hex.settlement) {				acc = hex.settlement.districts.reduce((districtAcc, district) => {					return district.buildingGrid.buildings.reduce((buildingAcc, building) => {						if (buildingAcc[building.building.name]) {							buildingAcc[building.building.name].count++						} else {							buildingAcc[building.building.name] = {building: building.building, count: 1}						}						return buildingAcc					}, districtAcc)				}, hexAcc)				return hex.settlement.settlementImprovements.reduce((imprAcc, improvement) => {					if (imprAcc[improvement.building.name]) {						imprAcc[improvement.building.name].count++					} else {						imprAcc[improvement.building.name] = {building: improvement.building, count: 1}					}					return imprAcc				}, acc)			} else				return acc		}, acc)	}, true)}decorate(HexData, {	ownedBy: observable,	hexImprovements: observable,	terrainType: observable,	label: observable,})decorate(HexDataGrid, {	loaded: observable,	selected: observable,})class Marker {	constructor(obj) {		this.id = obj.id		this.position.x = obj.x		this.position.y = obj.y		this.color = obj.color	}	id = -1	position = {		x: 0,		y: 0,	}	color = ""	toFormData = () => {		const formData = new FormData()		formData.append("xcoord", this.position.x.toString())		formData.append("ycoord", this.position.y.toString())		formData.append("color", this.color)		return formData	}}class Markers {	markerList = []	loaded = false	constructor() {		dbLoader("markers", "GET")			.then(obj => {				obj.forEach(v => this.markerList.push(new Marker(v)))				this.loaded = true			})		Settings.socket.on("markers", id => {			dbLoader("markers/" + id)				.then(obj => {					this.update(id, obj)				})		})	}	update = (id, obj) => {		const index = this.markerList.findIndex(v => v.id === id || v.id === -1)		if (index < 0 && obj) {			this.markerList.push(new Marker(obj))		} else if (index >= 0 && !obj) {			this.markerList.splice(index, 1)		}	}	addMarker = (x, y, color) => {		const newMarker = new Marker({id: -1, x: x, y: y, color: color})		const index = this.markerList.push(newMarker) - 1		dbLoader("markers", "PUT", newMarker.toFormData())			.then(response => {				this.markerList[index].id = response.id			})	}	removeMarker = (id) => {		const index = this.markerList.findIndex(v => v.id === id)		if (index >= 0) {			dbLoader("markers/" + id, "DELETE")				.then(() => {					this.markerList.splice(index, 1)				})		}	}}decorate(Markers, {	markerList: observable,	loaded: observable,})const markers = new Markers()const hexDataGrid = new HexDataGrid()hexDataGrid.initialize()export {HexData, hexDataGrid, Accumulator, markers}